unit Controller.Procedimento;

interface

uses
  System.JSON, System.SysUtils, System.Classes, System.Generics.Collections,
  REST.Types,
  Model.Procedimento, Model.Procedimento.Tipo,
  Service.RESTBase;

type
  TProcedimentoController = class(TRESTServiceBase)
  public
    function BuscarTodos: TObjectList<TProcedimento>;
    function BuscarPorId(AId: Int64): TProcedimento;
    function Salvar(AProcedimento: TProcedimento): Boolean;
    function Excluir(AId: Int64): Boolean;
  end;

implementation

uses
  Procedimento.Mapper;

function TProcedimentoController.BuscarTodos: TObjectList<TProcedimento>;
var
  JSONArray: TJSONArray;
  Item: TJSONValue;
  Mapper: TProcedimentoMapper;
begin
  Result := TObjectList<TProcedimento>.Create(True);
  Mapper := TProcedimentoMapper.Create;
  try
    FRESTRequest.Method := rmGET;
    FRESTRequest.Resource := 'procedimentos';
    FRESTRequest.Execute;

    if FRESTResponse.StatusCode = 200 then
    begin
      JSONArray := TJSONObject.ParseJSONValue(FRESTResponse.Content) as TJSONArray;
      for Item in JSONArray do
        Result.Add(Mapper.DeJSON(Item as TJSONObject));
    end;
  finally
    Mapper.Free;
  end;
end;

function TProcedimentoController.BuscarPorId(AId: Int64): TProcedimento;
var
  lJSONObject: TJSONObject;
begin
  Result := nil;
  FRESTRequest.Method := rmGET;
  FRESTRequest.Resource := Format('procedimentos/%d', [AId]);
  FRESTRequest.Execute;

  if FRESTResponse.StatusCode = 200 then
  begin
    lJSONObject := TJSONObject.ParseJSONValue(FRESTResponse.Content) as TJSONObject;
    Result := TProcedimentoMapper.Create.DeJSON(lJSONObject);
  end;
end;

function TProcedimentoController.Excluir(AId: Int64): Boolean;
begin
  FRESTRequest.Method := rmDELETE;
  FRESTRequest.Resource := Format('procedimentos/%d', [AId]);
  FRESTRequest.Body.ClearBody;
  FRESTRequest.Execute;

  Result := FRESTResponse.StatusCode = 200;
end;

function TProcedimentoController.Salvar(AProcedimento: TProcedimento): Boolean;
var
  lJSON: TJSONObject;
  lResource: string;
  lMetodo: TRESTRequestMethod;
  lResponseContent: string;
begin
  Result := False;
  lJSON := TProcedimentoMapper.Create.ParaJSON(AProcedimento);
  try
    if AProcedimento.Id = 0 then
    begin
      lMetodo := rmPOST;
      lResource := 'procedimentos';
    end
    else
    begin
      lMetodo := rmPUT;
      lResource := Format('procedimentos/%d', [AProcedimento.Id]);
    end;

    try
      lResponseContent := ExecutarRequisicao(lMetodo, lResource, lJSON.ToJSON);
      Result := FRESTResponse.StatusCode in [200, 201];
    except
      on E: Exception do
      begin
        AProcedimento.Aviso := FRESTResponse.Content;
        Result := False;
      end;
    end;
  finally
    lJSON.Free;
  end;
end;

end.

