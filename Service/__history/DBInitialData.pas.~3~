unit DBInitialData;

interface

uses
  System.SysUtils, System.Classes, ModelDB, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf,
  FireDAC.Stan.Def, FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys,
  FireDAC.Phys.MySQL, FireDAC.Phys.MySQLDef, FireDAC.VCLUI.Wait,
  FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf, FireDAC.DApt, Data.DB,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client, Model.Procedimento.Tipo;

type
  TDBInitialData = class
  private
    FModelDB: TDBModel;

    // Métodos auxiliares para inserção de dados
    function ExecutarSQL(const SQL: string; const Descricao: string): Boolean;
    function InserirProcedimentosPadroes: Boolean;

  public
    constructor Create(AModelDB: TDBModel);
    destructor Destroy; override;

    // Método principal para inserir dados iniciais
    function InserirDadosIniciais: Boolean;
  end;

implementation

uses
  System.DateUtils;

{ TDBInitialData }

constructor TDBInitialData.Create(AModelDB: TDBModel);
begin
  inherited Create;
  FModelDB := AModelDB;
end;

destructor TDBInitialData.Destroy;
begin
  // Não liberamos o ModelDB aqui pois foi passado por referência
  inherited;
end;

function TDBInitialData.ExecutarSQL(const SQL, Descricao: string): Boolean;
var
  Query: TFDQuery;
begin
  Result := False;
  Query := TFDQuery.Create(nil);
  try
    Query.Connection := FModelDB.FDConnection;
    try
      Query.SQL.Text := SQL;
      Query.ExecSQL;
      Result := True;
      WriteLn('Sucesso: ', Descricao);
    except
      on E: Exception do
      begin
        WriteLn('Erro ao ', Descricao, ': ', E.Message);
      end;
    end;
  finally
    Query.Free;
  end;
end;

function TDBInitialData.InserirProcedimentosPadroes: Boolean;
var
  Query: TFDQuery;
  Tipo: TTipoProcedimento;
  Descricao: string;
  Valor: Double;
  SQL: string;
begin
  Result := False;

  WriteLn('Inserindo procedimentos padrões...');

  Query := TFDQuery.Create(nil);
  try
    Query.Connection := FModelDB.FDConnection;

    // Primeiro verifica se já existem procedimentos para não duplicar
    Query.SQL.Text := 'SELECT COUNT(*) FROM procedimentos';
    Query.Open;
    if Query.Fields[0].AsInteger > 0 then
    begin
      WriteLn('Procedimentos já existem no banco. Pulando inserção.');
      Exit(True);
    end;

    // Insere os procedimentos padrões com valores base
    for Tipo := Low(TTipoProcedimento) to High(TTipoProcedimento) do
    begin
      Descricao := TipoProcedimentoDescricao(Tipo);

      // Define valores padrão para cada tipo
      case Tipo of
        tpAtencaoDomiciliar:     Valor := 100.00;
        tpPressaoArterial:       Valor := 30.00;
        tpTemperaturaCorporal:   Valor := 25.00;
        tpGlicemiaCapilar:       Valor := 40.00;
        tpInalacao:              Valor := 50.00;
        tpInjetaveis:            Valor := 60.00;
      else
        Valor := 0.00;
      end;

      SQL := 'INSERT INTO procedimentos (tipo, descricao, valor) VALUES (:tipo, :descricao, :valor)';
      Query.SQL.Text := SQL;
      Query.ParamByName('tipo').AsInteger := Ord(Tipo);
      Query.ParamByName('descricao').AsString := Descricao;
      Query.ParamByName('valor').AsFloat := Valor;

      try
        Query.ExecSQL;
        WriteLn('Procedimento inserido: ', TipoProcedimentoToStr(Tipo));
      except
        on E: Exception do
        begin
          WriteLn('Erro ao inserir procedimento ', TipoProcedimentoToStr(Tipo), ': ', E.Message);
          Exit(False);
        end;
      end;
    end;

    Result := True;
    WriteLn('Todos os procedimentos padrões foram inseridos com sucesso!');
  finally
    Query.Free;
  end;
end;

function TDBInitialData.InserirDadosIniciais: Boolean;
var
  Sucesso: Boolean;
begin
  if not FModelDB.ConectarBanco then
  begin
    WriteLn('Falha ao conectar ao banco de dados. Verifique as configurações.');
    Exit(False);
  end;

  try
    WriteLn('Iniciando inserção de dados iniciais...');

    // Insere os dados iniciais
    Sucesso := InserirProcedimentosPadroes;

    if Sucesso then
      WriteLn('Todos os dados iniciais foram inseridos com sucesso!')
    else
      WriteLn('Houve erros na inserção de alguns dados iniciais. Verifique os logs acima.');

    Result := Sucesso;
  finally
    FModelDB.DesconectarBanco;
  end;
end;

end.
