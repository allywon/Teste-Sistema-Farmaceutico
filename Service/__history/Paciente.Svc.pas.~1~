unit Paciente.SQL;

interface

uses
  FireDAC.Comp.Client, ModelDB, Model.Pessoa,
  System.Generics.Collections, System.SysUtils;

type
  TPacienteSQLHandler = class
  private
    FDB: TModelDB;
  public
    constructor Create(ADB: TModelDB);

    function ListarTodos: TArray<TPaciente>;
    function BuscarPorId(const Id: Int64): TPaciente;

    function Inserir(const APaciente: TPaciente): Boolean;
    function Atualizar(const Id: Int64; APaciente: TPaciente): Boolean;
    function Excluir(const Id: Int64): Boolean;

    function Carregar(const Id: Int64; APaciente: TPaciente): Boolean;
  end;

implementation

{ TPacienteSQLHandler }

constructor TPacienteSQLHandler.Create(ADB: TModelDB);
begin
  FDB := ADB;
end;

function TPacienteSQLHandler.ListarTodos: TArray<TPaciente>;
var
  Query: TFDQuery;
  Lista: TList<TPaciente>;
  P: TPaciente;
begin
  Lista := TList<TPaciente>.Create;
  Query := TFDQuery.Create(nil);
  try
    Query.Connection := FDB.FDConnection;
    Query.SQL.Text := 'SELECT * FROM Pacientes ORDER BY tipo';
    Query.Open;
    while not Query.Eof do
    begin
      P := TPaciente.Create;
      P.Id := Query.FieldByName('id').AsLargeInt;
      P.Tipo := TTipoPaciente(Query.FieldByName('tipo').AsInteger);
      P.Descricao := Query.FieldByName('descricao').AsString;
      P.Valor := Query.FieldByName('valor').AsCurrency;
      Lista.Add(P);
      Query.Next;
    end;
    Result := Lista.ToArray;
  finally
    Query.Free;
    Lista.Free;
  end;
end;

function TPacienteSQLHandler.BuscarPorId(const Id: Int64): TPaciente;
var
  Query: TFDQuery;
begin
  Result := nil;
  Query := TFDQuery.Create(nil);
  try
    Query.Connection := FDB.FDConnection;
    Query.SQL.Text := 'SELECT * FROM Pacientes WHERE id = :id';
    Query.ParamByName('id').AsLargeInt := Id;
    Query.Open;
    if not Query.IsEmpty then
    begin
      Result := TPaciente.Create;
      Result.Id := Query.FieldByName('id').AsLargeInt;
      Result.Tipo := TTipoPaciente(Query.FieldByName('tipo').AsInteger);
      Result.Descricao := Query.FieldByName('descricao').AsString;
      Result.Valor := Query.FieldByName('valor').AsCurrency;
    end;
  finally
    Query.Free;
  end;
end;

function TPacienteSQLHandler.Inserir(const Tipo: TTipoPaciente; const Descricao: string; const Valor: Currency): Boolean;
var
  Query: TFDQuery;
begin
  Result := False;
  Query := TFDQuery.Create(nil);
  try
    Query.Connection := FDB.FDConnection;
    Query.SQL.Text := 'INSERT INTO Pacientes (tipo, descricao, valor) VALUES (:tipo, :descricao, :valor)';
    Query.ParamByName('tipo').AsInteger := Ord(Tipo);
    Query.ParamByName('descricao').AsString := Descricao;
    Query.ParamByName('valor').AsCurrency := Valor;
    Query.ExecSQL;
    Result := True;
  finally
    Query.Free;
  end;
end;

function TPacienteSQLHandler.Atualizar(const Id: Int64; const Tipo: TTipoPaciente; const Descricao: string; const Valor: Currency): Boolean;
var
  Query: TFDQuery;
begin
  Result := False;
  Query := TFDQuery.Create(nil);
  try
    Query.Connection := FDB.FDConnection;
    Query.SQL.Text := 'UPDATE Pacientes SET tipo = :tipo, descricao = :descricao, valor = :valor WHERE id = :id';
    Query.ParamByName('id').AsLargeInt := Id;
    Query.ParamByName('tipo').AsInteger := Ord(Tipo);
    Query.ParamByName('descricao').AsString := Descricao;
    Query.ParamByName('valor').AsCurrency := Valor;
    Query.ExecSQL;
    Result := True;
  finally
    Query.Free;
  end;
end;

function TPacienteSQLHandler.Excluir(const Id: Int64): Boolean;
var
  Query: TFDQuery;
begin
  Result := False;
  Query := TFDQuery.Create(nil);
  try
    Query.Connection := FDB.FDConnection;
    Query.SQL.Text := 'SELECT COUNT(*) FROM servicos_farmaceuticos_itens WHERE Paciente_id = :id';
    Query.ParamByName('id').AsLargeInt := Id;
    Query.Open;
    if Query.Fields[0].AsInteger > 0 then
      Exit(False); // Está em uso
    Query.Close;
    Query.SQL.Text := 'DELETE FROM Pacientes WHERE id = :id';
    Query.ParamByName('id').AsLargeInt := Id;
    Query.ExecSQL;
    Result := True;
  finally
    Query.Free;
  end;
end;

function TPacienteSQLHandler.Carregar(const Id: Int64; Paciente: TPaciente): Boolean;
var
  Query: TFDQuery;
begin
  Result := False;
  if not Assigned(Paciente) then
    Exit;

  Query := TFDQuery.Create(nil);
  try
    Query.Connection := FDB.FDConnection;
    Query.SQL.Text := 'SELECT * FROM Pacientes WHERE id = :id';
    Query.ParamByName('id').AsLargeInt := Id;
    Query.Open;
    if not Query.IsEmpty then
    begin
      Paciente.Id := Query.FieldByName('id').AsLargeInt;
      Paciente.Tipo := TTipoPaciente(Query.FieldByName('tipo').AsInteger);
      Paciente.Descricao := Query.FieldByName('descricao').AsString;
      Paciente.Valor := Query.FieldByName('valor').AsCurrency;
      Result := True;
    end
    else
      Paciente.Limpar;
  finally
    Query.Free;
  end;
end;

end.

