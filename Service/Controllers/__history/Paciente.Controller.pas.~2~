unit Paciente.Controller;

interface

uses
  System.SysUtils, System.Classes, System.JSON, FireDAC.Comp.Client,
  Data.DB, ModelDB, Model.Pessoa, Paciente.Mapper, Paciente.Dao;

type
  TPacienteController = class
  private
    FModelDB: TModelDB;
    FMapper: TPacienteMapper;
    FPacienteDAO: TPacienteDAO;
  public
    constructor Create(AModelDB: TModelDB);
    destructor Destroy; override;
    function ObterPacientes: TJSONArray;
    function ObterPacientePorId(const Id: Int64): TJSONObject;
    function ObterPacientePorCPF(const CPF: string): TJSONObject;
    function InserirPaciente(APaciente: TPaciente): Boolean;
    function AtualizarPaciente(const Id: Int64; APaciente: TPaciente): Boolean;
    function ExcluirPaciente(const Id: Int64): Boolean;
    function CarregarPaciente(const Id: Int64; Paciente: TPaciente): Boolean;
  end;

implementation

{ TPacienteController }

constructor TPacienteController.Create(AModelDB: TModelDB);
begin
  inherited Create;
  FModelDB := AModelDB;
  FMapper := TPacienteMapper.Create;
  FPacienteDAO := TPacienteDAO.Create(AModelDB);
end;

destructor TPacienteController.Destroy;
begin
  FMapper.Free;
  FPacienteDAO.Free;
  inherited;
end;

function TPacienteController.ObterPacientes: TJSONArray;
var
  Lista: TArray<TPaciente>;
  Pac: TPaciente;
begin
  Result := TJSONArray.Create;
  try
    Lista := FPacienteDAO.ListarTodos;
    for Pac in Lista do
      Result.AddElement(FMapper.ParaJSON(Pac));
  except
    on E: Exception do
    begin
      Result.Free;
      raise Exception.Create('Erro ao obter pacientes: ' + E.Message);
    end;
  end;
end;

function TPacienteController.ObterPacientePorId(const Id: Int64): TJSONObject;
var
  Pac: TPaciente;
begin
  Pac := FPacienteDAO.BuscarPorId(Id);
  if Assigned(Pac) then
    Result := FMapper.ParaJSON(Pac)
  else
    Result := TJSONObject.Create;
  Pac.Free;
end;

function TPacienteController.ObterPacientePorCPF(const CPF: string): TJSONObject;
var
  Pac: TPaciente;
begin
  Pac := FPacienteDAO.BuscarPorCPF(CPF);
  if Assigned(Pac) then
    Result := FMapper.ParaJSON(Pac)
  else
    Result := TJSONObject.Create;
  Pac.Free;
end;

function TPacienteController.InserirPaciente(APaciente: TPaciente): Boolean;
begin
  Result := FPacienteDAO.Inserir(APaciente);
end;

function TPacienteController.AtualizarPaciente(const Id: Int64; APaciente: TPaciente): Boolean;
begin
  Result := FPacienteDAO.Atualizar(Id, APaciente);
end;

function TPacienteController.ExcluirPaciente(const Id: Int64): Boolean;
begin
  Result := FPacienteDAO.Excluir(Id);
end;

function TPacienteController.CarregarPaciente(const Id: Int64; Paciente: TPaciente): Boolean;
begin
  Result := FPacienteDAO.Carregar(Id, Paciente);
end;

end.
